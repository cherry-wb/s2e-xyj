#Linux文件系统权限控制

##1. Introduction

Linux是一种多用户操作系统，为了确保在多用户环境下的系统运转的安全性，Linux使用用户权限机制对系统进行管理，这种管理主要是通过文件管理机制完成的。为了保护系统的安全性，Linux系统对不同用户访问同一文件的权限做出了不同的规定，该安全模型是通过给系统中的文件赋予两个属性来起作用的，这两个属性称为所有者（ownership）和访问权限（access rights）。当用户意识到很多应用场景中这种广泛接受的机制并不能灵活、细粒度的满足控制需求，因而自Linux内核2.6版本开始便支持更为灵活的ACL(访问控制列表)机制。

##2. Linux文件系统权限管理机制

###2.1 文件类型

文件类型分为以下几种。  
d 目录  
l 符号链接  
s 套接字文件  
b 块设备文件  
c 字符设备文件  
p 命名管道文件  
- 普通文件  

###2.2 文件权限

####2.2.1 基本权限

文件权限，是指对文件的访问权限。对于一个Linux操作系统中的文件来说，它的权限可以分为3种：读的权限、写的权限和执行的权限，分别用r、w和x表示。不同的用户具有不同的读、写和执行的权限。

文件的另一个属性所有者是指每个文件都有一个特定的所有者，也就是对文件具有所有权的用户。同时，由于在Linux系统中，用户是按组分类的，一个用户属于一个或者多个组。文件所有者以外的用户又可以分为文件所有者的同组用户和其他用户。因此Linux系统按文件所有者、文件所有者同组用户和其他用户3类规定不同的访问权限。

####2.2.2 特殊权限

文件的权限还包括特殊权限，用来修饰基本权限，共同组成文件的权限系统。由于特殊权限会拥有一些特权，若无特殊需要不应启动它们。特殊权限包括SUID、SGID和Sticky。

SUID：可执行文件搭配该权限，便能任意存取文件属主能使用的全部系统资源。黑客经常利用该权限，以SUID配上root帐号，在系统中开后门。  
SGID：设在文件上，其效果和SUID类似，只是将文件属主换成同组用户。设在目录上，则所有被复制到该目录下的文件，其所属的用户组都会被重设为和该目录的相同，除非在复制文件时加上-p （保留文件属性），才能保持为原来的用户组。  
Sticky：在目录上设置了Sticky 位之后，只有属主和root 可以删除或更名文件。设在文件上，文件的更新时间将保持不变。  

###2.3 文件权限管理机制

####2.3.1 文件模式

Linux对每个文件设置一个16位二进制数来完成对文件的类型识别和存取控制，这个数字称为文件模式。文件模式的高4位通过组合来决定文件类型，在文件创建时写入，用户不能更改。低12位是文件的特殊权限和基本权限位。第11、10、9位是特殊权限组，一次为SUID、SGID、Sticky位；第8、7、6位和5、4、3位以及2、1、0位决定文件属主，同组用户、其他用户的rwx 权限。其中某一位为1，代表具有相关权限。把低12位分成4组，每组3位。用数字表示时，SUID、SGID、Sticky的数字值分别为4、2、1；r、w、x的数字值为4、2、1。因此，把每组的二进制串转换成对应一位八进制数，形成的4位数表示文件权限的数字形式。
####2.3.2 权限管理

使用ll命令查看文件的属性如下：  
-rwxr-xr--  1  root  root  45  7月 4  09：12  hello  
-rwxr-xr-- 是文件的属性，- 表示hello文件是一普通文件，rwx表示文件所有者拥有全部的权限，r-x表示同组用户可以读和执行这个文件，最后三位r-- 表示其他用户只能读此文件。  
1 表示该硬链接的数目；root 表示文件的所有者是root；root 表示文件所有者所在的用户组是root组；45表示文件的长度是45字节；7月4  09：12 表示文件的更新时间。  
通过这种文件存取许可机制，可以使得每个用户都可以对自己的文件加以保护，以免其他用户非法读取。很显然，系统中各种文件的权限设置对特定用户的数据安全有很大影响，要求用户小心设置。另外，用户改变文件的权限可以用命令chmod，改变文件的拥有者可用命令chown。系统还可用umask命令控制文件缺省的权限，其不用于屏蔽文件所有者的任何权限，只能屏蔽同组用户和其他用户的权限。  

###2.4 扩展的访问控制列表(ACL)方式

UGO访问控制机制在很多情况下难以满足实际文件/目录访问授权的需求，比如，要设定一个组中的部分用户对特定的文件/目录具有读取和访问权限(rw-)，而另外一部分用户只能具备读权限(r--);这在传统的Linux访问控制中无法通过单纯地建立新的组和用户来实现。因此，为了解决这些问题，人们提出了一种新的访问控制方法，也就是访问控制列表(ACL，AccessControlList)。

ACL是一个POSIX(可移植操作系统接口，PortableOperatingSystemInterface)标准。目前，支持ACL需要内核和文件系统的支持。现在2.6内核配合EXT2/EXT3,JFS,XFS,ReiserFS等文件系统都是可以支持ACL的。在目前主流的发行套件，如RedHatEnterpriseLinux(RHEL)5、RHEL6、Fedora16等等，都已经支持ACL。

####2.4.1 ACL的类型及权限位

ACL信息是以对象为索引，把所有对某一对象拥有访问权限的用户及其访问权限都组合在一起与此对象关联，称为这一对象的ACL属性。如果要对某一访问请求进行判断，则首先要找到被访问的对象，然后再在此对象的ACL属性中查找有无此请求所包含的用户，最后在此用户的访问权限集中检查有无此请求所需要的访问权限，如果有此权限则此请求合法。

ACL属性由一系列访问控制项组成，每一项为一个三元组：{权限类型 用户标志 权限集}，它代表来某个访问者对此对象的访问权限。ACL除了对传统的三种访问者身份的描述外，海天加来对另外的用户和组的描述。ACL是由一系列的AccessEntry所组成的。每一条AccessEntry定义了特定的类别可以对文件拥有的操作权限。AccessEntry主要包括6个，可分为两大类：一类包括owner、owninggroup和other，对应传统UGO机制中的user、group和other;一类则包括nameduser、namedgroup和mask。这六类的主要说明如下：

user：相当于Linux里文件所有者的permission  
nameduser：定义了额外的用户可以对此文件拥有的permission  
group：相当于Linux里group的permission  
namedgroup：定义了额外的组可以对此文件拥有的permission  
mask：定义了nameduser,namedgroup和group的最大权限  
other：相当于Linux里other的permission  

####2.4.2 ACL机制使用方法

"ACL的基本命令"

ACL的主要命令有2个：getfacl和setfacl。Getfacl用于或取文件或者目录的ACL权限信息，而setfacl则用于设置文件或者目录的ACL权限信息。下面分别对他们的使用进行简单介绍。

Getfacl-获取ACL权限信息

getfacl命令用于获取文件的ACL权限信息，其基本用法为：getfacl\[文件/目录名\]。值得注意的是：即使该文件系统上没有开启ACL选项，getfacl命令仍然可用，不过只显示默认的文件访问权限，即与ls-l显示的内容相似。 

Setfacl-设置ACL权限 

为了设置文件的ACL权限，需要使用setfacl命令来详细设置文件的访问权限，其基本用法如下： setfacl–\[参数\]\[文件/目录\]，其常用的参数及作用如下所示： -m：建立一个ACL规则 -x：删除一个ACL规则 　　-b：删除全部的ACL规则 　　-set：覆盖ACL规则 　　下面来详细介绍如何使用setfacl来设置文件/目录的ACL权限。

##3. Linux文件系统权限设置

文件的所有者可以用chmod命令更改文件的属性，也可以通过更改文件的属主把文件交给他人控制。

###3.1 chmod 的用法

命令：  
chmod 属性字 文件名  

属性字有两种用法，最基本的用法是使用字母，用u，g，o分别代表文件拥有者，组用户和其他用户，+ 和- 号用于调整权限。

例如：  
要给tt文件加上“拥有者可以执行”的权限，命令为chmod u+x tt  
取消tt的所有人可以读的属性的命令是chmod o-s tt。  

chmod另外的一种用法是使用数字，为拥有者，组用户和其他用户分别计算一个数，计算规则是r=4,w=2,x=1，然后相加（例如，r-x=5），最后将三个数连到一起。

例如：  
为tt分配一个rwxrw-r—的属性的命令是chmod 764 tt。  

###3.2 chown 的用法

文件的拥有者可以用chown命令将文件的所有权交给其他用户，但一旦交出就不能收回，例如，下面命令将tt的所有权交给root ：  
chown root tt  

###3.3 umask 的用法

一个有趣的问题是一个新创建的文件具有什么样的属性，这是通过umask命令实现的，设置了umask之后，你新创建的文件具有0777-umask的属性，例如，大部分系统的缺省umask是002，因此用户新创建的文件属性就是777-002=775或者rwxrwxr-x。你总可以用自己的设置来改变这个umask值，例如umask 066将使得你以后的文件自动具有711属性。直接输入不带参数的umask命令则显示当前的umask。

##4. Linux文件系统权限控制的安全分析

操作系统的安全性对计算机系统是至关重要的。虽然Linux系统采取了一些安全机制, 如: 身份标识与鉴别机制、文件访问控制机制和能力机制等,但仍然存在安全缺陷, 如: 超级用户( root) 可能权限过大、缓冲区溢出、文件系统访问控制机制不足等。

###4.1 安全等级

这种自主访问控制机制，根据中国国家标准GB17859-1999《计算机信息系统安全保护等级划分准则》和TCSEC标准，它仅仅处于第一级用户自主保护级别和C2级上。而中国国家标准中第二级系统审计保护级别和TCSEC标准中B1级，都要求访问控制粒度是单个用户，并且都要求系统中主体对客体的访问要同时满足自主访问控制和强制访问控制检查。

###4.2 安全隐患

文件系统是Unix/Linux系统安全的核心。在Unix/Linux中所有的资源都看作是文件。Unix/Linux文件安全是通过“9 bit”控制。每个文件有3组权限，一组是文件的拥有者、一组是文件所属组的成员、一组是其他所有用户。一旦这种控制操作设置不当就会给系统带来危害。例如假设 /etc/shadow文件允许任何人可读就会导致口令信息泄露。

特别注意，权限为SUID和SGID的可执行文件，在程序运行过程中，会给进程赋予所有者的权限，如果被黑客发现并利用就会给系统造成危害。因此，合理分配文件系统权限，是系统安全稳定运行的重要保证。

###4.3 ACL缺陷分析与改进思路

ACL虽然实现了更细粒度的访问控制，但它还存在一些不足和需要改进的地方。

1. 现在的ACL机制中，访问类型仍为读、写和执行三种，粒度还是显得过粗，应该在访问控制类型这一方面进一步细化。 
2. 在Linux传统的访问控制机制中，有一个授权的概念，如果当前进程得到了授权，那么它就成为了授权进程了，就可以凌驾于文件系统的访问权限控制机制之上，不必做权限检查就可以进行操作。授权的目的是为了给一些特殊用户提供特权，但是这种授权方式存在了一些问题，因为授权进程总是被赋予了许多不必要的全能，没有达到最小权限的安全目标。ACL机制还是保留来授权的概念，它在检查进程是否授权之前做了必要的权限检查，但还是没有消除授权所带来的权限未最小化的问题。
3. ACL在网络规模小的环境中是一种方便有效的访问控制方式，但是在需求复杂，网络规模较大的网中，ACL并不是一种很好的访问控制方式，因为ACL要对每个资源指定可以访问的用户或组以及相应的访问权限，如果网络中的资源很多，系统中会存储大量ACL表项，管理会变得很繁琐，而且当用户打开文件时，这些表象就要被读进内存，占用一定的内存空间。 
4. 将时间控制引入到ACL机制中。如果某个用户登录以后长时间没有使用，那么取消他的访问权限，如果想要访问的话重新登录，这样可以避免没有访问权限的用户使用此系统。

##5. Linux文件系统权限控制机制的安全相关案例

###5.1 案例：Linux Kernel PROC文件系统本地权限提升漏洞  
发布日期：2006-07-17  
CVE CAN ID：CVE-2006-3626  
**受影响的软件及系统：**  

RedHat Enterprise Linux WS 4  
RedHat Enterprise Linux ES 4  
RedHat Enterprise Linux Desktop 4  
RedHat Enterprise Linux AS 4  
Linux kernel 2.6.17.4  
Linux kernel 2.6.17.3  
Linux kernel 2.6.17.2  
Linux kernel 2.6.17.1  
Linux kernel 2.6.17  
Linux kernel 2.6.16  
Linux kernel 2.6.15  
Linux kernel 2.6.14  
Linux kernel 2.6.13  
Linux kernel 2.6.12  
Linux kernel 2.6.11  
Linux kernel 2.6.10  
Linux kernel 2.6.9  
Linux kernel 2.6.8  
Linux kernel 2.6.7  
Linux kernel 2.6.6  
Linux kernel 2.6.5  
Linux kernel 2.6.4  
Linux kernel 2.6.3  
Linux kernel 2.6.2  
Linux kernel 2.6.1  

Linux 2.6.1-2.6.17.4内核存在设计缺陷，普通用户可以利用该漏洞进行本地权限提升。

目前网络上已经有人发布了相应的漏洞利用代码，因此利用该漏洞的攻击事件有可能会大量出现。

**分析：**

Linux Kernel是开放源码操作系统Linux所使用的内核。  
Linux Kernel 2.6.1-2.6.17.4的proc文件系统存在一个竞争条件，普通攻击者可以通过该竞争条件结合SUID进行权限提升  
由于该漏洞利用起来成功率很高，一个普通用户只要有登录shell，就能利用该漏洞获得root权限，从而控制整个系统，因此会对大量Linux主机造成影响。  

##6. 总结

Linux的权限管理不够灵活，只能对所有者、所有者所在组和其他用户分配权限，无法做到进一步的细致化。但是由于Linux的开放性和自由性，其文件权限管理机制也在不断完善。一些版本的UNIX/Linux系统支持访问控制列表（ACL），它可以将对客体的存取控制细化到单个用户。

